# IoTB - IoT-Broker node module
created by DI Klaus Weichinger  snaky.1@gmx.at  

License: [GPLv3](./LICENSE)

Change-Log: [./doc/changelog.md](./doc/changelog.md)


## Installation
Setup a new IoT-Broker with following steps:

- sqlite3 is required

      sudo apt-get install libsqlite3-dev
      apt-get install sqlite3

- create a new directory e.g. `./iotbroker`

      mkdir iotbroker

- change to this directory

      cd ./iotbroker

- create a subdirectory `./db`

      mkdir db

- install the required iotb node-package from github with

      npm install github:weingaunity/iotb

- For web-pushnotifications a public and private key have to be generated with the command line tool [web-push](https://www.npmjs.com/package/web-push).

      web-push generate-vapid-keys > keys.txt

- within the directory `./iotbroker` create the file `server.js` with following content and change the settings (e.g. port, default admin username, password, ...). 

      var iotb = require('iotb');

      var iotbapp=iotb({
        port:8081,
        systemadministrator:"iotadmin - <yourmail>",
        defaultadmin:{
          user: "iotadmin",                     // default admin username
          username: "IoT Broker Administrator", // default admin username long
          password: "<yourpwd>",                // default admin password
          email: "<yourmail>"                   // admin user mail address
        },
        dbfile:"./db/iot.db",        
        webpush:{
          // copy content from keys.txt generated by web-push
          publickey: "<public key>",
          privatekey: "<private key>",
          email: "<yourmail>"
        },
        limits:{
          zipfileupload_mb:5,
          websitetotalsize_mb:10
        }
      });

      var app=iotbapp.express;

      iotbapp.run().then(()=>{
        console.log("IoT Broker listening on port "+iotbapp.config.port);
        let events = [
          {name: 'beforeExit', exitCode: 0 },
          {name: 'uncaughtExecption', exitCode: 1 },
          {name: 'SIGINT', exitCode: 130 },
          {name: 'SIGTERM', exitCode: 143 }
        ];
    
        events.forEach((e) => {
          process.on(e.name,  () => {
          iotbapp.stop()
            .then(() => { 
              console.log('connection cleaned');
              process.exit(e.exitCode);
            })
            .catch((err) => {
              console.error(err);
              process.exit(1);
            })    
          })
        });
      }).catch((e)=>{
        console.log("Error loading IoT Broker");
        console.log(e);
      });


## Run

Run the broker with following line

    node ./server.js

The web-interface of the broker can be opened within the browser with `localhost:8081` (or the port you selected).

## Hints

The `iotbapp` application object contains the membervariable `express` that contains the express application object of the broker. This express object can be used for custom API.